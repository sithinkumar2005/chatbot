<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>E-Governance Chatbot</title>
  <script src="https://cdn.tailwindcss.com"></script>
</head>

<body class="bg-gray-100 min-h-screen">

<!-- ================= NAVBAR ================= -->
<nav class="fixed top-0 left-0 w-full bg-blue-800 text-white px-6 py-4 flex justify-between items-center shadow-md z-50">

  <!-- Left -->
  <div class="flex items-center space-x-4">
    <span class="text-xl font-bold">ğŸ¤– AI E-Gov Chatbot</span>
    <span class="text-sm bg-blue-600 px-3 py-1 rounded-full">
      ID: {{ digital_id }}
    </span>
  </div>

  <!-- Center -->
  <div class="hidden md:flex space-x-6 text-sm">
    <a href="#chat" class="hover:underline">Chat</a>
    <a href="#documents" class="hover:underline">Documents</a>
    <a href="/api/complaint/" class="hover:underline">Complaints</a>
    <a href="#status" class="hover:underline">Status</a>
  </div>

  <!-- Right -->
  <div class="flex items-center space-x-4">
    <span class="text-sm hidden sm:block">
      {{ request.user.email }}
    </span>
    <a href="/api/logout/" class="bg-red-600 hover:bg-red-700 px-4 py-2 rounded-lg text-sm"> Logout </a>
  </div>

</nav>

<!-- ================= MAIN ================= -->
<div class="pt-28 pb-10 flex justify-center">

  <div class="w-full max-w-md bg-white rounded-xl shadow-lg p-5 space-y-6">

    <h1 class="text-2xl font-bold text-center">E-Governance Services</h1>

    <!-- ================= CHAT ================= -->
    <div id="chat">
      <h2 class="font-semibold mb-2">ğŸ’¬ Chat Assistant</h2>

      <div id="chatBox"
           class="h-60 border rounded-lg p-3 overflow-y-auto bg-gray-50 text-sm space-y-2">

        <!-- Bot welcome -->
        <div class="flex justify-start">
          <div class="bg-green-100 text-green-800 px-3 py-2 rounded-lg max-w-[85%]">
            ğŸ¤– Hello! I can help you with:
            <ul class="list-disc ml-4 mt-1">
              <li>How to create digital identity</li>
              <li>Required documents</li>
              <li>Verification time</li>
              <li>How to file complaint</li>
            </ul>
          </div>
        </div>

      </div>

      <div class="flex mt-2 gap-2">
        <input id="userInput"
               type="text"
               placeholder="Ask your question..."
               onkeydown="if(event.key==='Enter'){sendMessage()}"
               class="flex-1 border rounded-lg px-3 py-2 focus:outline-none focus:ring-2 focus:ring-blue-500">

        <button onclick="sendMessage()"
                class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-lg">
          Send
        </button>
      </div>
    </div>

    <!-- ================= DOCUMENTS ================= -->
    <div id="documents">
      <h2 class="font-semibold mb-2">ğŸ“„ Document Upload</h2>

      <input type="file" id="document" class="w-full border rounded-lg p-2">

      <button onclick="uploadDocument()"
        class="mt-2 w-full bg-green-600 hover:bg-green-700 text-white py-2 rounded-lg">
        Upload Document
      </button>

      <p id="uploadStatus" class="text-sm mt-1"></p>

      <div class="mt-3 text-sm">
        <h3 class="font-medium mb-1">Uploaded Documents</h3>
        <ul id="documentList" class="list-disc pl-5 text-gray-700">
          <li class="text-gray-400">No documents uploaded yet</li>
        </ul>
      </div>
    </div>

    <!-- ================= COMPLAINT ================= -->
    <div id="complaints">
      <h2 class="font-semibold mb-2">ğŸ“ Register Complaint</h2>

      <select id="department" class="w-full border rounded-lg p-2 mb-2">
        <option>Electricity</option>
        <option>Water</option>
        <option>Roads</option>
        <option>Police</option>
      </select>

      <input id="issue"
             type="text"
             placeholder="Issue type"
             class="w-full border rounded-lg p-2 mb-2">

      <textarea id="description"
                placeholder="Describe your problem"
                class="w-full border rounded-lg p-2 mb-2"></textarea>

      <button onclick="submitComplaint()"
        class="w-full bg-purple-600 hover:bg-purple-700 text-white py-2 rounded-lg">
        Submit Complaint
      </button>

      <p id="complaintStatus" class="text-sm mt-1"></p>
    </div>

    <!-- ================= STATUS ================= -->
    <div id="status">
      <h2 class="font-semibold mb-2">ğŸ“Š Status</h2>
      <div class="text-sm bg-gray-50 border rounded-lg p-3">
        Track complaint progress and document verification status here.
      </div>
    </div>

  </div>
</div>

<!-- ================= JS ================= -->
<script>
const API = "http://127.0.0.1:8000/api";

/* ================= CHAT ================= */
function sendMessage() {
  const input = document.getElementById("userInput");
  const chatBox = document.getElementById("chatBox");
  const message = input.value.trim();

  if (!message) return;

  // USER MESSAGE
  chatBox.innerHTML += `
    <div class="flex justify-end mb-2">
      <div class="bg-blue-600 text-white px-3 py-2 rounded-lg max-w-[80%]">
        ${message}
      </div>
    </div>
  `;

  input.value = "";
  chatBox.scrollTop = chatBox.scrollHeight;

  fetch(`${API}/chat/`, {
    method: "POST",
    headers: {
      "Content-Type": "application/json"
    },
    body: JSON.stringify({ message })
  })
  .then(res => {
    if (!res.ok) {
      throw new Error("Server error");
    }
    return res.json();
  })
  .then(data => {
    const reply = data.reply || "Sorry, I didn't understand that.";

    // BOT MESSAGE
    chatBox.innerHTML += `
      <div class="flex justify-start mb-2">
        <div class="bg-green-100 text-green-800 px-3 py-2 rounded-lg max-w-[80%]">
          ğŸ¤– ${reply}
        </div>
      </div>
    `;
    chatBox.scrollTop = chatBox.scrollHeight;
  })
  .catch(error => {
    console.error("Chat error:", error);

    chatBox.innerHTML += `
      <div class="flex justify-start mb-2">
        <div class="bg-red-100 text-red-700 px-3 py-2 rounded-lg max-w-[80%]">
          âš ï¸ Unable to connect to chatbot
        </div>
      </div>
    `;
    chatBox.scrollTop = chatBox.scrollHeight;
  });
}
/* ================= DOCUMENT UPLOAD ================= */
function uploadDocument() {
  const file = document.getElementById("document").files[0];
  const status = document.getElementById("uploadStatus");
  const list = document.getElementById("documentList");

  if (!file) {
    status.textContent = "âŒ Select a document";
    status.className = "text-red-600";
    return;
  }

  const formData = new FormData();
  formData.append("document", file);

  fetch(`${API}/document/upload/`, { method: "POST", body: formData })
  .then(res => res.json())
  .then(data => {
    status.textContent = "âœ… " + data.message;
    status.className = "text-green-600";
    list.innerHTML += `<li>${file.name}</li>`;
  });
}

/* ================= COMPLAINT ================= */
function submitComplaint() {
  const dept = document.getElementById("department").value;
  const issue = document.getElementById("issue").value;
  const desc = document.getElementById("description").value;
  const status = document.getElementById("complaintStatus");

  if (!issue || !desc) {
    status.textContent = "âŒ Please fill all fields";
    status.className = "text-red-600";
    return;
  }

  fetch(`${API}/complaint/register/`, {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({
      department: dept,
      issue_type: issue,
      description: desc
    })
  })
  .then(res => res.json())
  .then(data => {
    status.textContent = `âœ… Complaint submitted (Priority: ${data.priority})`;
    status.className = "text-green-600";
  });
}
</script>

</body>
</html>
