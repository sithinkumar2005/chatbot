<!DOCTYPE html>
<html>
<head>
    <title>Complaints</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>

<body class="bg-gray-100 min-h-screen">

<form style="display:none;">
    {% csrf_token %}
</form>

<!-- NAVBAR -->
<nav class="bg-blue-700 text-white p-4 flex justify-between items-center">
    <div class="font-bold text-lg">E-Gov AI System</div>

    <div class="space-x-4">
        <a href="/api/" class="hover:underline">Home</a>
        <a href="/api/chat/" class="hover:underline">Chat</a>
        <a href="/api/documents/" class="hover:underline">Documents</a>
        <a href="/api/complaint/" class="underline font-bold">Complaints</a>
        <a href="/api/logout/" class="hover:underline">Logout</a>
    </div>

    <div class="text-sm bg-blue-900 px-3 py-1 rounded">
        Digital ID: {{ digital_id }}
    </div>
</nav>


<div class="max-w-4xl mx-auto p-6 space-y-8">

    <!-- REGISTER -->
    <div class="bg-white p-6 rounded shadow">
        <h2 class="text-xl font-bold mb-4">Register Complaint</h2>

        <input id="department" placeholder="Department"
            class="border p-2 w-full mb-3 rounded">

        <input id="issue_type" placeholder="Issue Type"
            class="border p-2 w-full mb-3 rounded">

        <textarea id="description" placeholder="Describe your issue"
            class="border p-2 w-full mb-3 rounded"></textarea>

        <button id="submitBtn" type="button" onclick="registerComplaint()"
            class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded w-full">
            Submit Complaint
        </button>

        <div id="register_result" class="mt-4 hidden rounded p-3"></div>
    </div>


    <!-- TRACK -->
    <div class="bg-white p-6 rounded shadow">
        <h2 class="text-xl font-bold mb-4">Track Complaint</h2>

        <input id="cid" placeholder="Complaint ID"
            class="border p-2 w-full mb-3 rounded">

        <button type="button" onclick="trackComplaint()"
            class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded w-full">
            Check Status
        </button>

        <div id="status_result" class="mt-4 hidden rounded p-3"></div>
    </div>


    <!-- DASHBOARD ALERTS -->
    <div class="bg-white p-6 rounded shadow">
        <h2 class="text-xl font-bold mb-4">My Complaints</h2>
        <button onclick="loadMyComplaints()"
            class="bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded mb-4">
            Refresh List
        </button>

        <div id="my_list" class="space-y-2"></div>
    </div>

</div>


<script>
// ================= CSRF =================
function getCSRFToken() {
    const match = document.cookie.match(/csrftoken=([^;]+)/);
    return match ? match[1] : "";
}


// ================= REGISTER =================
async function registerComplaint() {

    const btn = document.getElementById("submitBtn");
    btn.disabled = true;

    const dept = department.value.trim();
    const issue = issue_type.value.trim();
    const desc = description.value.trim();

    const box = register_result;
    box.classList.remove("hidden");

    if (!dept || !issue || !desc) {
        showError(box, "All fields required");
        btn.disabled = false;
        return;
    }

    box.className = "mt-4 rounded p-3 bg-gray-100";
    box.innerText = "Submitting...";

    try {

        const res = await fetch("/api/complaint/register/", {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
                "X-CSRFToken": getCSRFToken()
            },
            credentials: "same-origin",
            body: JSON.stringify({
                department: dept,
                issue_type: issue,
                description: desc
            })
        });

        const data = await res.json();
        console.log("REGISTER RESPONSE:", data);

        if (!res.ok) throw data;

        box.className = "mt-4 rounded p-3 bg-green-100 text-green-800";
        box.innerHTML = `
            âœ… Complaint Registered<br>
            Priority: <b>${data.priority}</b><br>
            Complaint ID: <b>${data.complaint_id}</b>
        `;

        // auto fill track field
        cid.value = data.complaint_id;

        loadMyComplaints();

    } catch (err) {
        console.log("REGISTER ERROR:", err);
        showError(box, err.error || err.detail || "Registration failed");
    }

    btn.disabled = false;
}


// ================= TRACK =================
async function trackComplaint() {

    const id = cid.value.trim().toUpperCase();
    const box = status_result;
    box.classList.remove("hidden");

    if (!id) {
        showError(box, "Enter Complaint ID");
        return;
    }

    box.className = "mt-4 rounded p-3 bg-gray-100";
    box.innerText = "Checking...";

    try {

        const res = await fetch(`/api/complaint/status/${id}/`, {
            credentials: "same-origin"
        });

        const data = await res.json();
        console.log("STATUS RESPONSE:", data);

        if (!res.ok) throw data;

        box.className = "mt-4 rounded p-3 bg-blue-100 text-blue-800";
        box.innerHTML = `
            ðŸ“Œ Status: <b>${data.status}</b><br>
            Priority: <b>${data.priority}</b><br>
            Department: ${data.department}<br>
            Issue: ${data.issue_type}
        `;

    } catch (err) {
        console.log("STATUS ERROR:", err);
        showError(box, err.error || "Complaint not found");
    }
}


// ================= DASHBOARD LIST =================
async function loadMyComplaints() {

    const list = document.getElementById("my_list");
    list.innerHTML = "Loading...";

    try {
        const res = await fetch("/api/complaint/my/", {
            credentials: "same-origin"
        });

        const data = await res.json();

        if (!res.ok) throw data;

        list.innerHTML = data.map(c => `
            <div class="border p-3 rounded bg-gray-50">
                <b>${c.complaint_id}</b> â€” ${c.department}<br>
                Status: ${c.status} | Priority: ${c.priority}
            </div>
        `).join("");

    } catch {
        list.innerHTML = "Failed to load";
    }
}


// ================= ERROR BOX =================
function showError(box, msg) {
    box.className = "mt-4 rounded p-3 bg-red-100 text-red-800";
    box.innerText = msg;
}


// auto load list on open
loadMyComplaints();

</script>

</body>
</html>
